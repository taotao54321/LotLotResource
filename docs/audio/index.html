<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>ロットロット (FC) 攻略/解析 - オーディオドライバ</title>

    <link rel="stylesheet" href="../asset/css/main.css">
</head>
<body>

<header><a href="../">ロットロット (FC) 攻略/解析</a></header>

<h1>オーディオドライバ</h1>

<p>オーディオドライバは毎フレーム tick され、音楽および効果音を適宜 tick し、その結果を元に調停を行いつつ APU レジスタへの書き込みを行う。</p>

<p>音楽および効果音は仮想マシン上のバイトコードで実装されている。詳細は個別の項目を参照:</p>

<ul>
    <li><a href="music/">音楽</a></li>
    <li><a href="sound/">効果音</a></li>
</ul>

<p>オーディオドライバは以下の状態を持つ:</p>

<ul>
    <li>再生中の音楽ID: 0 または 0xFF (None)。</li>
    <li>再生中の効果音ID: <code>0..=14</code> または 0xFF (None)。</li>
    <li>再生中の効果音の nice 値: 値が小さい方が優先度が高い (同点の場合、後から再生要求された方が優先される)。</li>
    <li>効果音が使用する APU チャンネルマスク: 矩形波A, 矩形波B, 三角波、ノイズが対象。音楽との調停用。<br>値 0xFF は効果音が未再生であることを示す。</li>
    <li>APU レジスタ値キャッシュ: 大まかには <code>$4000-$400F</code> に「直前に書いた」値を保持する。実際には恣意的な値に設定されることもある。</li>
    <li><a href="music/">音楽</a>仮想マシン。</li>
    <li><a href="sound/">効果音</a>仮想マシン。</li>
</ul>

<h2>オーディオドライバインターフェース概要</h2>

<p>オーディオドライバは以下の外部インターフェースを備えている:</p>

<table>
<thead><tr><th>機能</th><th>説明</th></tr></thead>
<tbody>
<tr><td><a href="#AudioInit">オーディオドライバ(再)初期化</a></td><td>オーディオドライバの状態を初期化する。再生中の音楽/効果音は停止する。<br>メインスレッドから呼ばれる。</td></tr>
<tr><td><a href="#AudioTick">オーディオドライバの tick</a></td><td>オーディオドライバを tick し、音楽/効果音の再生を進める。<br>NMI スレッドから呼ばれる。</td></tr>
<tr><td><a href="#PlayMusic">音楽再生要求</a></td><td>指定した音楽を再生要求する。<br>メインスレッドから呼ばれる。</td></tr>
<tr><td><a href="#PlaySound">効果音再生要求</a></td><td>指定した効果音を再生要求する。<br>メインスレッドから呼ばれる。</td></tr>
</tbody>
</table>

<h2>オーディオドライバインターフェース詳細</h2>

<h3 id="AudioInit">オーディオドライバ(再)初期化ルーチン</h3>

<p>本ルーチンが呼ばれると、以下の(再)初期化が行われる:</p>

<ul>
    <li>矩形波A, 矩形波B, 三角波、ノイズの 4 APU チャンネルの有効化。</li>
    <li>三角波とノイズの音量調整 (DMC レジスタ <code>$4011</code> への書き込みによる)。</li>
    <li>再生中の音楽IDおよび効果音IDを None とする。</li>
    <li>再生中の効果音の nice 値を 0xFF とする。これにより、任意の効果音の再生が受け付けられるようになる。</li>
    <li>再生中の効果音の APU チャンネルマスクを 0xFF とする。(<span class="note">NOTE</span>: この状態では音楽再生要求を行っても音楽が鳴らない)</li>
    <li>APU レジスタ値キャッシュ全体を 0xFF で埋める。</li>
    <li>音楽仮想マシンおよび効果音仮想マシンを(再)初期化する。これにより両者の動作が停止する。</li>
</ul>

<p><span class="note">NOTE</span>: 本ルーチンを呼んだ後に音楽を再生するには、事前に何か効果音を再生して効果音 APU チャンネルマスクを更新する必要がある。効果音ID 0 はこれを行うためのダミーと考えられる。</p>

<h3 id="AudioTick">オーディオドライバ tick ルーチン</h3>

<p>本ルーチンは毎フレーム NMI スレッドから呼ばれ、以下の処理を行う (疑似コード):</p>

<pre class="example"><code class="example">APU フレームカウンタレジスタ $4017 に値 0xC0 (5-step) を書き、VBLANK との同期をとる

// 音楽処理。
// 音楽バイトコードは常に無限ループするので、終了処理は存在しない。
音楽仮想マシンを 1 回 tick
// ボーナスタイム中は音楽のテンポを 1.5 倍にする。
if (現在の面の目標スコアを達成済み)
    NMI カウンタが偶数ならばさらに音楽仮想マシンを 1 回 tick

// 効果音処理。再生中の効果音IDが 0 (ダミー) ならば処理全体をスキップする。
if (再生中の効果音ID) != 0
    if (効果音ウェイトカウンタ) != 0
        効果音仮想マシンを 1 回 tick
    else
        // この場合、効果音が終了しているか、もしくは未再生。
        (再生中の効果音ID) = 0xFF
        (再生中の効果音の nice 値) = 0xFF
        // 未再生の場合、効果音 APU チャンネルマスクは 0xFF のままになる (音楽が鳴らない状態が続く)。
        if (再生中の効果音の APU チャンネルマスク bit7 が 0)
            (再生中の効果音の APU チャンネルマスク) = 0

// 音楽側の APU レジスタへの書き込み要求を処理。
for (APU チャンネル) in [矩形波A, 矩形波B, 三角波, ノイズ]
    // 効果音は音楽より優先される。
    if (効果音 APU チャンネルマスクにこのチャンネルが含まれる)
        continue
    for (APU レジスタ) in (このチャンネルに対応する APU レジスタ 4 つ) // 降順
        value = (音楽側で書き込み要求した値)
        // 既に APU レジスタ値キャッシュに同じ値があればスキップ (2 重書き込みを避ける)。
        if value != (APU レジスタ値キャッシュ内の値)
            (APU レジスタ) = value
            (対応する APU レジスタ値キャッシュエントリ) = value
</code></pre>

<p>音楽側の 2 重書き込み防止処理により、1 つの音符内では発音タイミングでのみ APU レジスタへの書き込みが行われるようになっている。</p>

<h3 id="PlayMusic">音楽再生要求ルーチン</h3>

<p>本ルーチンは音楽IDを引数にとる。本作の音楽は 1 つしかないので、引数の音楽IDは常に 0 である。</p>

<p>本ルーチンが呼ばれると、以下のように音楽関連の状態が初期化される:</p>

<ul>
    <li>再生中の音楽IDに引数の値 (0) を代入する。</li>
    <li>音楽仮想マシンに対して音楽ID (0) を与えて初期化を行う。</li>
</ul>

<h3 id="PlaySound">効果音再生要求ルーチン</h3>

<p>本ルーチンは効果音ID <code>0..=14</code> を引数にとる。</p>

<p>本ルーチンが呼ばれると、以下の処理を行う (疑似コード):</p>

<pre class="example"><code class="example">// 再生中の効果音の方が優先度が高ければ何もしない。
if (要求された効果音の nice 値) &gt; (再生中の効果音の nice 値)
    return

(再生中の効果音の nice 値) = (要求された効果音の nice 値)

// 同じ効果音を多重再生しようとした場合、何もしない。
// ただし効果音 11 (ミス音) のみは例外。
if (要求された効果音ID) == (再生中の効果音ID) &amp;&amp; (要求された効果音ID) != 11
    return

(再生中の効果音ID) = (要求された効果音ID)

再生中の効果音の APU チャンネルマスクを更新

効果音仮想マシンに対して要求された効果音IDを与えて初期化を行う
</code></pre>

<h2>不具合</h2>

<p>本作は RAM <code>$07AF</code> の初期値が 0xFF だと音楽/効果音の<span class="xxx">ノイズチャンネルが発音されない</span>。以下の環境でこの問題の発生を確認している:</p>

<ul>
    <li>筆者所有のニューファミコン</li>
    <li>デフォルト設定の FCEUX および NesHawk</li>
</ul>

<p>これは、<span class="xxx">音楽側の APU レジスタ値バッファ <code>$07A0-$07AF</code> が初期化されない</span>ことが原因。本作はノイズチャンネルについてはオーディオドライバ tick 処理内の音楽側 APU レジスタ値書き込みによって 1 回だけ音長無限で発音させ、後は音量調整のみによってノイズを制御するようになっている (音楽/効果音バイトコード内には <code>$400F</code> への書き込み命令が存在しない)。しかしこれは音楽側の書き込み要求値 <code>$07AF</code> が 0xFF でないことに依存しており、この条件が満たされない場合、APU レジスタ値キャッシュの初期値が 0xFF であることから、2 重書き込み防止処理によって <code>$400F</code> には書き込みが行われなくなる。</p>

<p>また、上記の通りノイズチャンネル発音タイミングは音楽の再生開始後となるので、<span class="xxx">電源投入/リセット直後の 1 面開始時はジングルのノイズチャンネルが発音されない</span>。これは RAM の初期値によらず発生する。</p>

<p>他に、電源投入/リセット直後は音楽の再生開始前に三角波を使う効果音を再生しないと音楽の三角波が無音になる問題もあるが、面開始ジングルは三角波を使うのでこの問題は表面化していない。これは APU レジスタ値キャッシュが 0xFF で初期化されることが原因 (音楽は三角波制御レジスタ <code>$4008</code> に 0xFF を書いて音長を無限とするよう要求するが、キャッシュされた値が 0xFF の場合、書き込み要求が無視される)。</p>

</body>
</html>
